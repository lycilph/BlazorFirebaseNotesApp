@page "/login"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject Services.FirebaseAuthStateProvider authStateProvider

<PageTitle>Login</PageTitle>

<h3>Login</h3>

<div class="card">
    <div class="card-body">
        <div class="form-group">
            <label>Email address</label>
            <input class="form-control" @bind="email" />
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" class="form-control" @bind="password" />
        </div>
        <button class="btn btn-primary mt-3" @onclick="HandleLogin">Login</button>
        <button class="btn btn-secondary mt-3" @onclick="HandleSignUp">Sign Up</button>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mt-3">@errorMessage</div>
        }
    </div>
</div>

@code {
    private string email;
    private string password;
    private string errorMessage;
    
    // This property will be populated from the URL, e.g., /login?returnUrl=%2F
    [SupplyParameterFromQuery]
    public string ReturnUrl { get; set; }

    private async Task HandleLogin()
    {
        await Authenticate(async () => await AuthService.LoginAsync(email, password));
    }

    private async Task HandleSignUp()
    {
        await Authenticate(async () => await AuthService.SignUpAsync(email, password));
    }

    // A shared method to handle both login and sign up logic
    private async Task Authenticate(Func<Task<FirebaseAuthResponse>> authAction)
    {
        errorMessage = string.Empty;
        try
        {
            var response = await authAction();
            if (!string.IsNullOrEmpty(response?.idToken))
            {
                await localStorage.SetItemAsync("authToken", response.idToken);
                authStateProvider.NotifyUserAuthentication(response.idToken);

                // THE FIX: Wait for the next UI render cycle before navigating.
                // This gives the AuthorizeRouteView time to recognize the new auth state.
                await Task.Yield();

                // Navigate to the return URL if it exists, otherwise to the home page.
                NavigationManager.NavigateTo(ReturnUrl ?? "", forceLoad: false);
            }
            else
            {
                errorMessage = "Authentication failed. Please check your credentials or the email may be in use.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
    }
}